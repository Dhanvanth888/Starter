<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>System Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
    .card { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; padding: 12px; }
    .btn { transition: all 0.15s ease-in-out; border-bottom-width: 4px; }
    .btn:active { transform: translateY(2px); border-bottom-width: 0px; margin-top: 2px; }
    .terminal { font-family: 'Courier New', monospace; background: #000; color: #22c55e; height: 140px; overflow-y: auto; padding: 10px; font-size: 11px; border-radius: 8px; border: 1px solid #334155; }
  </style>
</head>
<body class="p-4 max-w-md mx-auto">

  <div class="flex items-center justify-between mb-6">
    <h1 class="text-xl font-bold flex items-center gap-2">
      <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span> 
      System Control
    </h1>
    <div class="text-xs text-slate-500" id="clock">--:--</div>
  </div>

  <div class="grid grid-cols-2 gap-3 mb-5">
    <div class="card flex flex-col items-center">
      <span class="text-[10px] uppercase text-slate-400 tracking-wider">Voltage 1</span>
      <span id="V1" class="text-2xl font-bold text-blue-400">0</span>
    </div>
    <div class="card flex flex-col items-center">
      <span class="text-[10px] uppercase text-slate-400 tracking-wider">Voltage 2</span>
      <span id="V2" class="text-2xl font-bold text-blue-400">0</span>
    </div>
    <div class="card flex flex-col items-center">
      <span class="text-[10px] uppercase text-slate-400 tracking-wider">Voltage 3</span>
      <span id="V3" class="text-2xl font-bold text-blue-400">0</span>
    </div>
    <div class="card flex flex-col items-center border-orange-900/30 bg-orange-900/10">
      <span class="text-[10px] uppercase text-orange-400/70 tracking-wider">Current</span>
      <span id="amps" class="text-2xl font-bold text-orange-500">0.00</span>
    </div>
  </div>

  <div class="flex gap-4 mb-6">
    <button id="btnM1" onclick="toggleDevice('M1')" class="btn flex-1 h-16 bg-slate-700 border-slate-900 rounded-2xl font-bold text-lg text-slate-300">
      M1 <span class="block text-xs font-normal opacity-50">OFF</span>
    </button>
    <button id="btnM2" onclick="toggleDevice('M2')" class="btn flex-1 h-16 bg-slate-700 border-slate-900 rounded-2xl font-bold text-lg text-slate-300">
      M2 <span class="block text-xs font-normal opacity-50">OFF</span>
    </button>
  </div>

  <div class="card mb-5">
    <h3 class="text-xs font-bold uppercase text-slate-400 mb-2">Timer Configuration (Sec)</h3>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="text-[10px] text-slate-500">On Time</label>
        <input type="number" id="on_time" class="w-full bg-slate-900 p-2 rounded border border-slate-700 text-center text-white focus:border-indigo-500 outline-none" placeholder="0">
      </div>
      <div>
        <label class="text-[10px] text-slate-500">Off Time</label>
        <input type="number" id="off_time" class="w-full bg-slate-900 p-2 rounded border border-slate-700 text-center text-white focus:border-indigo-500 outline-none" placeholder="0">
      </div>
    </div>
    <button onclick="saveTimers()" class="w-full mt-3 bg-indigo-600 hover:bg-indigo-500 py-2 rounded-lg font-bold text-sm transition text-white shadow-lg">Update Timers</button>
  </div>

  <div class="card p-0 overflow-hidden">
    <div class="bg-slate-800/50 px-3 py-2 flex justify-between items-center border-b border-slate-700/50">
      <span class="text-[10px] font-bold uppercase text-slate-400">Live Terminal</span>
      <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
    </div>
    <div id="terminal" class="terminal space-y-1">
      <div>> Dashboard initialized...</div>
      <div>> Waiting for data...</div>
    </div>
  </div>
  
  <div class="mt-4 text-center">
    <p class="text-[10px] text-slate-600">History</p>
    <div id="history-log" class="text-xs text-slate-400 mt-2 space-y-1"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBPMbOob953J0zzpnyX0imFLdHt7s4r9OQ",
      authDomain: "starter-2cedf.firebaseapp.com",
      databaseURL: "https://starter-2cedf-default-rtdb.firebaseio.com",
      projectId: "starter-2cedf",
      storageBucket: "starter-2cedf.firebasestorage.app",
      messagingSenderId: "961972630822",
      appId: "1:961972630822:web:fe62ca2251f6db91b67de7",
      measurementId: "G-RPLDSWPC7Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ðŸŸ¢ Listen to 'Starter' Node
    onValue(ref(db, 'Starter'), (snap) => {
      const d = snap.val();
      if (!d) return;

      // 1. Telemetry: Uppercase V1, V2, V3 / Lowercase amps
      document.getElementById('V1').innerText = (d.V1 || 0);
      document.getElementById('V2').innerText = (d.V2 || 0);
      document.getElementById('V3').innerText = (d.V3 || 0);
      document.getElementById('amps').innerText = (d.amps || 0);

      // 2. Buttons: Uppercase M1, M2 ("1"=ON, "0"=OFF)
      updateBtn('btnM1', 'M1', d.M1);
      updateBtn('btnM2', 'M2', d.M2);

      // 3. Timers: Lowercase keys
      if(document.activeElement.id !== "on_time") {
        document.getElementById('on_time').value = d.on_time || 0;
      }
      if(document.activeElement.id !== "off_time") {
        document.getElementById('off_time').value = d.off_time || 0;
      }
    });

    onValue(ref(db, 'notification'), (snap) => {
      const logDiv = document.getElementById('history-log');
      logDiv.innerHTML = "";
      snap.forEach(child => {
        logDiv.innerHTML = `<div><span class="text-slate-500">[${child.key}]</span> ${child.val()}</div>` + logDiv.innerHTML;
      });
    });

    // --- Actions ---

    window.toggleDevice = (key) => {
      // Key is explicitly "M1" or "M2" from onclick
      const btn = document.getElementById('btn' + key);
      const isOff = btn.innerText.includes("OFF");
      const newVal = isOff ? "1" : "0"; // Send "1" or "0"
      
      log(`Setting ${key} to ${newVal}`);
      update(ref(db, 'Starter'), { [key]: newVal });
    };

    window.saveTimers = () => {
      const onVal = document.getElementById('on_time').value;
      const offVal = document.getElementById('off_time').value;
      
      // Save using lowercase keys
      update(ref(db, 'Starter'), { 
        on_time: onVal, 
        off_time: offVal 
      });
      log(`Timers saved.`);
    };

    function updateBtn(elementId, label, val) {
      const el = document.getElementById(elementId);
      const isOn = String(val) === "1"; 
      
      el.innerHTML = `${label} <span class="block text-xs font-normal opacity-70">${isOn ? 'ON' : 'OFF'}</span>`;
      
      if (isOn) {
        el.className = "btn flex-1 h-16 bg-green-600 border-green-800 rounded-2xl font-bold text-lg text-white shadow-[0_0_15px_rgba(34,197,94,0.4)]";
      } else {
        el.className = "btn flex-1 h-16 bg-slate-700 border-slate-900 rounded-2xl font-bold text-lg text-slate-300";
      }
    }

    function log(msg) {
      const t = document.getElementById('terminal');
      t.innerHTML += `<div>> ${msg}</div>`;
      t.scrollTop = t.scrollHeight;
    }

    setInterval(() => {
      document.getElementById('clock').innerText = new Date().toLocaleTimeString();
    }, 1000);
  </script>
</body>
</html>
